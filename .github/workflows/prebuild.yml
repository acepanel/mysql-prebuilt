name: MySQL Prebuilt Packages
on:
  push:
    branches: [main]
  workflow_dispatch:
concurrency:
  group: "prebuild-mysql"
  cancel-in-progress: true
jobs:
  build:
    name: ${{ matrix.mysql.channel }} ${{ matrix.mysql.version }} for ${{ matrix.os.name }} ${{ matrix.os.version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        mysql:
          - { channel: "mariadb", slug: "114", version: "11.4.9" }
          - { channel: "mariadb", slug: "118", version: "11.8.5" }
          - { channel: "mysql", slug: "57", version: "5.7.44" }
          - { channel: "mysql", slug: "80", version: "8.0.44" }
          - { channel: "mysql", slug: "84", version: "8.4.7" }
          - { channel: "percona", slug: "57", version: "5.7.44-53" }
          - { channel: "percona", slug: "80", version: "8.0.44-35" }
          - { channel: "percona", slug: "84", version: "8.4.7-7" }
        os:
          # Debian
          - { name: "debian", version: "12", image: "debian:12" }
          - { name: "debian", version: "13", image: "debian:13" }
          # Ubuntu
          - { name: "ubuntu", version: "22", image: "ubuntu:22.04" }
          - { name: "ubuntu", version: "24", image: "ubuntu:24.04" }
          # AlmaLinux
          - { name: "almalinux", version: "9", image: "almalinux:9" }
          - { name: "almalinux", version: "10", image: "almalinux:10" }
    container:
      image: ${{ matrix.os.image }}
      options: --privileged
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup container environment
        run: |
          retry_command() {
            local max_attempts=999
            local attempt=1
            until "$@"; do
              echo "命令执行失败 (尝试 $attempt/$max_attempts)，10秒后重试..."
              sleep 10
              attempt=$((attempt + 1))
            done
            echo "命令执行成功"
          }

          if command -v apt-get >/dev/null 2>&1; then
            export DEBIAN_FRONTEND=noninteractive
            retry_command apt-get update -y
            retry_command apt-get install -y bash wget git make systemd p7zip p7zip-full
            retry_command apt-get install -y build-essential cmake ninja-build doxygen graphviz bison libncurses5-dev libtirpc-dev libssl-dev pkg-config libsystemd-dev libldap2-dev libudev-dev libsasl2-dev libsasl2-modules-gssapi-mit patchelf libkrb5-dev zlib1g-dev libbz2-dev liblz4-dev liblzma-dev libreadline-dev libicu-dev libprotoc-dev libprotobuf-dev protobuf-compiler libcurl4-openssl-dev libxml2-dev libpcre2-dev libaio-dev libatomic1 libquadmath0
            # Debian 13+ 和 Ubuntu 25+ 单独安装 systemd-dev
            if { [ "${{ matrix.os.name }}" = "debian" ] && [ "${{ matrix.os.version }}" -ge "13" ]; } || { [ "${{ matrix.os.name }}" = "ubuntu" ] && [ "${{ matrix.os.version }}" -ge "25" ]; }; then
              retry_command apt-get install -y systemd-dev
            fi
            # Debian 13+ 和 Ubuntu 24+ 需要安装 libaio1t64，其他系统安装 libaio1 即可
            if { [ "${{ matrix.os.name }}" = "debian" ] && [ "${{ matrix.os.version }}" -ge "13" ]; } || { [ "${{ matrix.os.name }}" = "ubuntu" ] && [ "${{ matrix.os.version }}" -ge "24" ]; }; then
              retry_command apt-get install -y libaio1t64
            else
              retry_command apt-get install -y libaio1
            fi
          elif command -v dnf >/dev/null 2>&1; then
            retry_command dnf makecache
            retry_command dnf install -y dnf-plugins-core
            if [ "${{ matrix.os.version }}" = "8" ]; then
              retry_command dnf config-manager --set-enabled powertools
            else
              retry_command dnf config-manager --set-enabled crb
            fi
            retry_command dnf install -y epel-release
            retry_command dnf config-manager --set-enabled epel
            retry_command dnf install -y bash wget git make systemd p7zip p7zip-plugins
            retry_command dnf groupinstall "Development Tools" -y
            retry_command dnf install -y cmake ninja-build doxygen graphviz bison ncurses-devel libtirpc-devel openssl-devel pkg-config systemd-devel openldap-devel libudev-devel cyrus-sasl-devel cyrus-sasl-scram patchelf rpcgen rpcsvc-proto-devel krb5-devel zlib-devel bzip2-devel lz4-devel xz-devel readline-devel libicu-devel protobuf-lite-devel protobuf-devel protobuf-compiler libcurl-devel libxml2-devel pcre2-devel libaio libaio-devel libatomic libquadmath-devel
          fi
      - name: Build MySQL
        run: |
          chmod +x build_mysql.sh
          ./build_mysql.sh "${{ matrix.mysql.channel }}" "${{ matrix.mysql.slug }}" "${{ matrix.mysql.version }}"
      - name: Package MySQL
        id: package
        run: |
          ARCH=$(uname -m)
          OS_NAME="${{ matrix.os.name }}"
          OS_VERSION="${{ matrix.os.version }}"
          PACKAGE_NAME="${{ matrix.mysql.channel }}-server-${{ matrix.mysql.version }}-${OS_NAME}${OS_VERSION}-${ARCH}"
          mv /opt/ace/server/mysql/${{ matrix.mysql.channel }}-server-*.7z "${PACKAGE_NAME}.7z"
          echo "name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.name }}
          path: ${{ steps.package.outputs.name }}.7z
          compression-level: 0
          retention-days: 90
  create-release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -name "*.7z" -exec cp {} release/ \;
          ls -la release/
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "#${{ github.run_number }}"
          name: "#${{ github.run_number }}"
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
